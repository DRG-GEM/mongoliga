<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Comedor Escolar</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; }
.admin-only { display: none; }
.user-only { display: none; }
.student-item { transition: all 0.2s ease-in-out; }
.student-item.pending { background-color: #374151; }
.student-item.present { background-color: #166534; transform: scale(1.02); }
.student-item.absent { background-color: #991b1b; text-decoration: line-through; opacity: 0.6; }
#role-selection-screen { backdrop-filter: blur(10px); }
#history-modal, #generic-modal { transition: opacity 0.3s ease; }
</style>
</head>
<body class="bg-gray-900 text-white antialiased">

<!-- App principal -->
<div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl opacity-0 transition-opacity duration-500">
  <header class="text-center mb-8">
    <h1 class="text-4xl font-bold text-cyan-400">Gestor de Comedor</h1>
    <p id="role-display" class="text-gray-400 mt-2 font-semibold">Cargando...</p>
  </header>
  
  <div id="admin-login-view" class="hidden text-center">
      <h2 class="text-2xl font-semibold mb-6">Acceso de Administrador</h2>
      <button id="login-admin-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center justify-center gap-3 mx-auto">
        <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.19,4.73C14.03,4.73 15.69,5.36 16.95,6.57L19.05,4.54C17.22,2.77 15,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.19,22C17.6,22 21.54,18.22 21.54,12.33C21.54,11.76 21.48,11.43 21.35,11.1V11.1Z"></path></svg>
        <span>Iniciar Sesión con Google</span>
      </button>
  </div>

  <div id="main-content" class="hidden">
      <!-- Selección de turno -->
      <div id="shift-selection" class="text-center">
        <h2 class="text-2xl font-semibold mb-4">Elige un turno de comedor</h2>
        <div id="shift-buttons" class="flex flex-wrap justify-center gap-4">
          <button class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg text-lg" data-shift="Primer Turno (Infantil)">Primer Turno (Infantil)</button>
          <button class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg text-lg" data-shift="Segundo Turno (Primaria)">Segundo Turno (Primaria)</button>
        </div>
        <div class="mt-8 admin-only">
          <h3 class="text-xl font-semibold mb-4">Gestión de Datos</h3>
          <button id="import-csv-btn-initial" class="bg-green-600 hover:bg-green-500 font-bold py-3 px-6 rounded-lg">📤 Importar Alumnos (CSV)</button>
          <button id="wipe-db" class="bg-red-600 hover:bg-red-500 font-bold py-3 px-6 rounded-lg">🗑️ Borrar todos los alumnos</button>
          <p id="import-status-initial" class="text-green-400 mt-2 h-6"></p>
        </div>
      </div>

      <!-- Dashboard -->
      <main id="dashboard" class="hidden">
        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
          <button id="back-to-shifts" class="bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded-lg">&larr; Cambiar Turno</button>
          <div class="flex flex-wrap gap-4">
            <button id="import-csv-btn-dashboard" class="bg-green-600 hover:bg-green-500 font-bold py-2 px-4 rounded-lg admin-only">📤 Importar Alumnos (CSV)</button>
            <button id="export-csv-btn-dashboard" class="bg-blue-600 hover:bg-blue-500 font-bold py-2 px-4 rounded-lg admin-only">💾 Exportar CSV del Día</button>
            <button id="finalize-shift-btn" class="bg-orange-600 hover:bg-orange-500 font-bold py-2 px-4 rounded-lg">🏁 Finalizar Turno</button>
          </div>
        </div>
        <p id="import-status-dashboard" class="text-center text-green-400 mb-4 h-6"></p>

        <section id="summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-gray-800 p-4 rounded-lg text-center"><h3 class="text-lg font-semibold text-gray-400">Comensales del Día</h3><p id="summary-diners" class="text-3xl font-bold">0</p></div>
          <div class="bg-red-800 bg-opacity-50 p-4 rounded-lg text-center"><h3 class="text-lg font-semibold text-red-300">Ausentes</h3><p id="summary-absent" class="text-3xl font-bold">0</p></div>
          <div class="bg-blue-800 bg-opacity-50 p-4 rounded-lg text-center"><h3 class="text-lg font-semibold text-blue-300">Pendientes</h3><p id="summary-pending" class="text-3xl font-bold">0</p></div>
          <div class="bg-green-800 bg-opacity-50 p-4 rounded-lg text-center"><h3 class="text-lg font-semibold text-green-300">PRESENTES</h3><p id="summary-present" class="text-3xl font-bold">0</p></div>
        </section>

        <section id="student-lists">
          <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
      </main>
  </div>
</div>

<input type="file" id="csv-file-input" class="hidden" accept=".csv">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- Configuración Firebase ---
  const firebaseConfig = {
  apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
  authDomain: "comedorvp.firebaseapp.com",
  projectId: "comedorvp",
  storageBucket: "comedorvp.firebasestorage.app",
  messagingSenderId: "821870274048",
  appId: "1:821870274048:web:62b85d28ceace395245ae5"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const googleProvider = new firebase.auth.GoogleAuthProvider();
  let userRole = null;
  const appState = { currentShift: null, students: [], attendance: {} };

  const dom = {
    app: document.getElementById('app'),
    roleDisplay: document.getElementById('role-display'),
    shiftSelection: document.getElementById('shift-selection'),
    dashboard: document.getElementById('dashboard'),
    coursesContainer: document.getElementById('courses-container'),
    csvFileInput: document.getElementById('csv-file-input'),
    importStatusInitial: document.getElementById('import-status-initial'),
    importStatusDashboard: document.getElementById('import-status-dashboard'),
    wipeDbBtn: document.getElementById('wipe-db'),
    finalizeShiftBtn: document.getElementById('finalize-shift-btn'),
    adminLoginView: document.getElementById('admin-login-view'),
    mainContent: document.getElementById('main-content')
  };

  // --- UI ---
  function setUIVisibility() {
    dom.app.classList.remove('opacity-0');
    
    // Ocultar todas las vistas principales primero
    dom.adminLoginView.classList.add('hidden');
    dom.mainContent.classList.add('hidden');

    if (userRole === 'admin') {
        dom.mainContent.classList.remove('hidden');
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        document.querySelectorAll('.user-only').forEach(el => el.style.display = 'none');
        const user = auth.currentUser;
        dom.roleDisplay.textContent = user ? `Admin: ${user.displayName}` : 'Admin';
    } else if (userRole === 'user') {
        dom.mainContent.classList.remove('hidden');
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.user-only').forEach(el => el.style.display = 'block');
        dom.roleDisplay.textContent = 'Modo: Profesor / Cuidador';
    } else if (userRole === 'login') {
        dom.adminLoginView.classList.remove('hidden');
        dom.roleDisplay.textContent = 'Acceso de Administrador';
    }
  }

  // --- Firestore helpers ---
  async function fetchStudents(shift) {
    let query = db.collection("students");
    if (shift) {
        query = query.where("shift", "==", shift);
    }
    const snapshot = await query.get();
    return snapshot.docs.map(doc => ({id:doc.id, ...doc.data()}));
  }
  async function addStudentBatch(students) {
    const batch = db.batch();
    const collection = db.collection("students");
    students.forEach(s => {
      if(s.name && s.course && s.shift){
        batch.set(collection.doc(), {name:s.name.trim(), course:s.course.trim(), shift:s.shift.trim()});
      }
    });
    await batch.commit();
  }
  async function deleteAllStudents() {
    const snapshot = await db.collection("students").get();
    const batch = db.batch();
    snapshot.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
  }
  async function logAttendance(studentId, dateStr, state) {
    if (studentId.startsWith('sporadic_')) return;
    const docRef = db.collection("attendance").doc(`${studentId}_${dateStr}`);
    await docRef.set({studentId, date: dateStr, state});
  }
   async function logBatchAttendance(studentsToUpdate, dateStr, state) {
    const validStudents = studentsToUpdate.filter(id => !id.startsWith('sporadic_'));
    if (validStudents.length === 0) return;
    const batch = db.batch();
    const collection = db.collection("attendance");
    validStudents.forEach(studentId => {
      const docRef = collection.doc(`${studentId}_${dateStr}`);
      batch.set(docRef, { studentId, date: dateStr, state });
    });
    await batch.commit();
  }
  async function fetchAttendanceByDate(dateStr) {
    const snapshot = await db.collection("attendance").where("date","==",dateStr).get();
    const data = {};
    snapshot.docs.forEach(doc=>data[doc.data().studentId]=doc.data().state);
    return data;
  }

  // --- Render ---
  function updateSummary() {
    const vals = Object.values(appState.attendance);
    dom.summary = {
      diners: document.getElementById('summary-diners'),
      absent: document.getElementById('summary-absent'),
      pending: document.getElementById('summary-pending'),
      present: document.getElementById('summary-present')
    };
    dom.summary.diners.textContent = vals.length;
    dom.summary.absent.textContent = vals.filter(s=>'absent'===s).length;
    dom.summary.present.textContent = vals.filter(s=>'present'===s).length;
    dom.summary.pending.textContent = vals.filter(s=>'pending'===s).length;
  }

  function createStudentElement(s){
    return `<div id="${s.id}" class="student-item p-3 rounded-md cursor-pointer flex justify-between items-center mt-2 ${appState.attendance[s.id]||'pending'}" data-student-id="${s.id}" data-student-name="${s.name}"><span>${s.name}</span><button class="mark-absent-btn bg-red-500 hover:bg-red-400 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center">&times;</button></div>`;
  }

  async function renderCourses(shift) {
    appState.currentShift = shift;
    dom.shiftSelection.classList.add('hidden');
    dom.dashboard.classList.remove('hidden');
    dom.coursesContainer.innerHTML = '<p class="text-center text-lg">Cargando alumnos...</p>';
    appState.students = await fetchStudents(shift);
    const today = new Date().toISOString().slice(0,10);
    const attendance = await fetchAttendanceByDate(today);
    appState.attendance = {};
    appState.students.forEach(s=>appState.attendance[s.id]=attendance[s.id]||'pending');
    dom.coursesContainer.innerHTML = '';
    const courses = [...new Set(appState.students.map(s=>s.course))].sort();
    if(courses.length===0){
      dom.coursesContainer.innerHTML='<p class="text-center text-lg text-gray-400">No hay alumnos en este turno.</p>';
    }else{
      courses.forEach(course=>{
        const card = document.createElement('div');
        card.className='bg-gray-800 rounded-lg p-4 shadow-lg flex flex-col';
        const list = appState.students.filter(s=>s.course===course).map(createStudentElement).join('');
        const sporadicBtn = userRole === 'user' ? `<button class="add-sporadic-btn mt-4 bg-purple-600 hover:bg-purple-500 font-bold py-2 px-4 rounded-lg" data-course="${course}">+ Añadir Esporádico</button>` : '';
        card.innerHTML=`<div class="flex-grow"><h3 class="text-xl font-bold text-cyan-300 mb-3">${course}</h3><div class="space-y-2" data-course-list="${course}">${list}</div></div>${sporadicBtn}`;
        dom.coursesContainer.appendChild(card);
      });
    }
    updateSummary();
  }

  // --- CSV Import ---
  function handleCsvImport(file){
    if(!file) return;
    [dom.importStatusInitial,dom.importStatusDashboard].forEach(el=>el.textContent='Procesando archivo...');
    Papa.parse(file,{header:true,skipEmptyLines:true,complete: async (results)=>{
      const headers = results.meta.fields.map(h => h.toLowerCase().trim());
      if(!headers.includes('nombre') || !headers.includes('curso') || !headers.includes('turno')){
        [dom.importStatusInitial,dom.importStatusDashboard].forEach(el=>el.textContent='Error: CSV debe tener columnas "nombre", "curso", y "turno"');
        return;
      }
      await deleteAllStudents();
      const studentsToImport = results.data.map(r => ({
          name: r.nombre ? r.nombre.trim() : '',
          course: r.curso ? r.curso.trim() : '',
          shift: r.turno ? r.turno.trim() : ''
      }));
      await addStudentBatch(studentsToImport);
      [dom.importStatusInitial,dom.importStatusDashboard].forEach(el=>el.textContent='Importación completa ✅');
      if (appState.currentShift) {
          renderCourses(appState.currentShift);
      }
    },error: err=>{[dom.importStatusInitial,dom.importStatusDashboard].forEach(el=>el.textContent='Error: '+err.message);}});
  }

  // --- CSV Export ---
  async function exportFullDayCsv(dateStr){
    const allStudents = await fetchStudents(null); // Fetch all students, no shift filter
    const attendance = await fetchAttendanceByDate(dateStr);
    const rows = allStudents.map(s=>{
      const state = attendance[s.id]||'pending';
      return {Fecha:dateStr, Turno:s.shift, Nombre:s.name, Curso:s.course, Estado:state};
    });
    rows.sort((a,b) => a.Turno.localeCompare(b.Turno) || a.Curso.localeCompare(b.Curso) || a.Nombre.localeCompare(b.Nombre));
    const csv = Papa.unparse(rows);
    const blob = new Blob([`\uFEFF${csv}`],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`asistencia_completa_${dateStr}.csv`; a.click();
    URL.revokeObjectURL(url);
  }
  
  // --- Add Sporadic ---
  function addSporadicStudent(course) {
    const name = prompt(`Nombre del alumno esporádico para ${course}:`);
    if (name && name.trim()) {
        const student = {
            id: `sporadic_${Date.now()}`,
            name: `${name.trim()} (Esporádico)`,
            course: course
        };
        appState.students.push(student);
        appState.attendance[student.id] = 'pending';
        const listContainer = document.querySelector(`[data-course-list="${course}"]`);
        if (listContainer) {
            listContainer.insertAdjacentHTML('beforeend', createStudentElement(student));
        }
        updateSummary();
    }
  }
  
  // --- Finalize Shift ---
  async function finalizeShift() {
      if (!confirm("¿Seguro que quieres finalizar el turno? Todos los alumnos pendientes pasarán a estar ausentes.")) {
          return;
      }
      const today = new Date().toISOString().slice(0, 10);
      const studentsToMarkAbsent = [];
      for (const studentId in appState.attendance) {
          if (appState.attendance[studentId] === 'pending') {
              studentsToMarkAbsent.push(studentId);
              appState.attendance[studentId] = 'absent';
              const studentDiv = document.getElementById(studentId);
              if (studentDiv) {
                  studentDiv.classList.remove('pending');
                  studentDiv.classList.add('absent');
              }
          }
      }
      await logBatchAttendance(studentsToMarkAbsent, today, 'absent');
      updateSummary();
  }
  
  // --- Main App Logic & Routing ---
  function handleAppInitialization() {
    const path = window.location.pathname.toLowerCase();

    auth.onAuthStateChanged(user => {
      if (user) {
        // User is signed in, this must be an admin.
        userRole = 'admin';
        setUIVisibility();
      } else {
        // No user signed in.
        if (path.startsWith('/admin')) {
          userRole = 'login'; // Show the login button view
          setUIVisibility();
        } else {
          // On any other page, default to user role.
          userRole = 'user';
          setUIVisibility();
        }
      }
    });
  }

  // Initial call
  handleAppInitialization();

  // --- Event Listeners ---
  document.getElementById('login-admin-btn').addEventListener('click', () => {
    auth.signInWithPopup(googleProvider).catch(error => {
        console.error("Google Sign-In Error:", error);
        alert("No se pudo iniciar sesión con Google.");
    });
  });

  document.querySelectorAll('#shift-buttons button').forEach(btn=>{
    btn.addEventListener('click', ()=>renderCourses(btn.dataset.shift));
  });
  dom.csvFileInput.addEventListener('change', e=>handleCsvImport(e.target.files[0]));
  document.getElementById('import-csv-btn-initial').addEventListener('click', ()=>dom.csvFileInput.click());
  document.getElementById('import-csv-btn-dashboard').addEventListener('click', ()=>dom.csvFileInput.click());
  dom.wipeDbBtn.addEventListener('click', async ()=>{if(confirm('¿Seguro que quieres borrar todos los alumnos?')){await deleteAllStudents(); if(appState.currentShift){renderCourses(appState.currentShift);}}});
  document.getElementById('export-csv-btn-dashboard').addEventListener('click', ()=>{
    const dateStr = prompt('Introduce la fecha a exportar (YYYY-MM-DD)', new Date().toISOString().slice(0,10));
    if(dateStr) exportFullDayCsv(dateStr);
  });
  dom.finalizeShiftBtn.addEventListener('click', finalizeShift);
  document.getElementById('back-to-shifts').addEventListener('click', ()=>{dom.dashboard.classList.add('hidden'); dom.shiftSelection.classList.remove('hidden');});

  dom.coursesContainer.addEventListener('click', async e=>{
    const studentDiv = e.target.closest('.student-item');
    const sporadicBtn = e.target.closest('.add-sporadic-btn');
    
    if (sporadicBtn) {
        addSporadicStudent(sporadicBtn.dataset.course);
        return;
    }

    if(!studentDiv) return;
    const studentId = studentDiv.dataset.studentId;
    let newState;
    if(e.target.classList.contains('mark-absent-btn')){
      newState = appState.attendance[studentId] === 'absent' ? 'pending' : 'absent';
    } else {
      newState = appState.attendance[studentId] === 'present' ? 'pending' : 'present';
    }
    appState.attendance[studentId] = newState;

    studentDiv.classList.remove('pending','present','absent');
    studentDiv.classList.add(newState);
    updateSummary();
    await logAttendance(studentId, new Date().toISOString().slice(0,10), newState);
  });

});
</script>
</body>
</html>

